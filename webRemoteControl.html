<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="pyramid web application">
		
		<title>remoteControl</title>
		
		<style type="text/css">
			input[type=range][orient=vertical] {
				writing-mode: bt-lr; /* IE */
				-webkit-appearance: slider-vertical; /* WebKit */
				width: 8px;
				height: 175px;
				padding: 0 5px;
			}
			.sliders>div {
				display: inline-block;
				margin: 1em;
			}
		</style>
		

	</head>
	<body>
		<h1>remoteControl</h1>
		
		<div>
			<input id="host_input" type="text">
		</div>
		
		<div class="sliders">
			<div id="hsv_top">
				<h2>hsv top</h2>
			</div>
			<div id="hsv_floor">
				<h2>hsv floor</h2>
			</div>
			<div id="raw">
				<h2>raw dmx</h2>
				<div id="raw_sliders"></div>
				<div id="raw_controls"></div>
			</div>
		</div>
		
		<div class="buttons">
			<button onclick="send_lights('all', 'hsv:1,1,1,1')">all</button>
			<button onclick="send_lights('all', 'hsv:0,0,0,0')">off</button>
		</div>

		
		<script type="text/javascript">
			var DEFAULT_PORT = "9873";
			var NUM_RAW_SLIDERS = 8;

			
			// Socket ----------------------------------------------------------
			
			var socket = null;
			
			function connect() {
				var host = document.getElementById('host_input').value;
				socket = new WebSocket("ws://"+host+"/");
				socket.onopen = function() {
					socket.send(JSON.stringify({action: "subscribe", data: ["None"]}));
				};
				socket.onopen = function() {
					localStorage.host = host;
				};
				socket.onclose = function() {
					console.log("connection lost ", host);
				}
			}

			document.getElementById('host_input').addEventListener('keydown', function(event) {
				if (event.keyCode==13) {
					connect();
				}
			}, true);

			function send_lights(device, value) {
				socket.send(JSON.stringify({action: "message", data: [{deviceid: 'lights', func: 'lights.set',
					device: device,
					value: value,
				},]}));
            }

			
			// Slider ----------------------------------------------------------
			
			function createSlider(device, type, slider_group) {
				var slider = document.createElement('input');
				slider.setAttribute('type', 'range');
				slider.setAttribute('orient', 'vertical');
				slider.setAttribute('min', '0');
				slider.setAttribute('max', '1');
				slider.setAttribute('step', 1/255);
				slider.setAttribute('value', '0');
				slider.setAttribute('data-device', device);
				slider.setAttribute('data-type', type);
				slider.addEventListener('input', function(event){
					var value;
					if (Array.isArray(slider_group)) {
						var values = []; for (var index in slider_group) {values.push(slider_group[index].value);}
						value = type+':'+values.join(',');
					}
					else {
						value = event.target.value;
					}
					send_lights(slider.getAttribute('data-device'), value);
				}, true);
				return slider;
			}
			
			function createSliderGroup(device, type, size) {
				var slider_group = [];
				for (var i=0 ; i<size ; i++) {
					slider_group.push(createSlider(device, type, slider_group));
				}
				return slider_group;
			}
			
			function appendChildren(parent, children) {
				for (var index in children) {
					parent.appendChild(children[index]);
				}
			}

			function raw_slider_controls() {
                var container = document.createElement('div');
				var index_display = document.createElement('input');
				index_display.value = 0;
				index_display.onchange = function() {
					sliders = document.getElementById('raw_sliders').getElementsByTagName('input');
					for (index in sliders) {
						var slider = sliders[index];
						if (!slider.getAttribute) {continue;}
						slider.setAttribute('data-device', Number(index_display.value) + Number(index));
						slider.value = 0;
					}
				}
				
				function create_button(text, increment) {
					var button = document.createElement('button');
					button.innerHTML = text;
					button.onclick = function(event){
						index_display.value = Math.max(0, Number(index_display.value) + Number(increment));
						index_display.onchange();
					};
					return button;
                }
				
				appendChildren(container, [
					index_display,
					create_button('<', -NUM_RAW_SLIDERS),
					create_button('>',  NUM_RAW_SLIDERS),
				]);
				return container;
            }
			
			// Init ------------------------------------------------------------
			
			window.onload = function() {
				document.getElementById('host_input').value = localStorage.host || ((window.location.hostname || 'localhost')+":"+DEFAULT_PORT);
				
				appendChildren(document.getElementById('hsv_top')  , createSliderGroup('top'  , 'hsv', 4));
				appendChildren(document.getElementById('hsv_floor'), createSliderGroup('floor', 'hsv', 4));
				
				var sliders = [];
				for (var i=0 ; i<NUM_RAW_SLIDERS ; i++) {
					sliders.push(createSlider(i));
				}
				appendChildren(document.getElementById('raw_sliders'), sliders);
				
				document.getElementById('raw_controls').appendChild(raw_slider_controls());
				
				connect();
			}
		</script>
	</body>
</html>
