<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="pyramid web application">
		
		<title>remoteControl</title>
		
		<style type="text/css">
			input[type=range][orient=vertical] {
				writing-mode: bt-lr; /* IE */
				-webkit-appearance: slider-vertical; /* WebKit */
				width: 8px;
				height: 175px;
				padding: 0 5px;
			}
			.sliders>div {
				display: inline-block;
				margin: 1em;
			}
		</style>
		

	</head>
	<body>
		<h1>remoteControl</h1>
		
		<div>
			<input id="host_input" type="text">
		</div>
		
		<div class="sliders">
			<div id="hsv_top">
				<h2>hsv top</h2>
			</div>
			<div id="hsv_floor">
				<h2>hsv floor</h2>
			</div>
			<div id="raw">
				<h2>raw dmx</h2>
				<div id="raw_sliders"></div>
				<div id="raw_controls"></div>
			</div>
		</div>
		
		<div class="buttons">
			<button onclick="send_lights('all', 'rgb:1,1,1');">all</button>
			<button onclick="send_clear();">off</button>
		</div>

		
		<script type="text/javascript">
			var DEFAULT_PORT = "9873";
			var NUM_RAW_SLIDERS = 8;

			// MidiConfig (To be removed and served as json) -------------------
			
			var midiDeviceConfigs = {
				"nanoKONTROL2 SLIDER/KNOB": {
					commands: {
						next_raw: {
							input_id: 62
						},
						prev_raw: {
							input_id: 61
						},
						smoke: {
							input_id: 100
						},
						all: {
							input_id: 41
						},
						clear: {
							input_id: 42
						},
						all_hold: {
							type: "hold",
							input_id: 45
						}
					},
					devices: {
						top: {
							type: "hsv",
							sliders: [16,17,18]
						},
						floor: {
							type: "hsv",
							sliders: [20,21,22]
						}
					},
					raw: {
						sliders: [0,1,2,3,4,5,6,7]
					}
				}
			};
			
			// Socket ----------------------------------------------------------
			
			var socket = null;
			
			function connect() {
				var host = document.getElementById('host_input').value;
				socket = new WebSocket("ws://"+host+"/");
				socket.onopen = function() {
					socket.send(JSON.stringify({action: "subscribe", data: ["None"]}));
				};
				socket.onopen = function() {
					localStorage.host = host;
				};
				socket.onclose = function() {
					console.log("connection lost ", host);
				};
			}

			document.getElementById('host_input').addEventListener('keydown', function(event) {
				if (event.keyCode==13) {
					connect();
				}
			}, true);

			function send_lights(device, value) {
				socket.send(JSON.stringify({action: "message", data: [{deviceid: 'lights', func: 'lights.set',
					device: device,
					value: value
				}]}));
			}

			function send_clear() {
				socket.send(JSON.stringify({action: "message", data: [{deviceid: 'lights', func: 'lights.clear'}]}));
			}
			
			// Midi ------------------------------------------------------------
			
			function initMidi() {
				// http://webaudiodemos.appspot.com/slides/webmidi.html
				// http://www.keithmcmillen.com/blog/making-music-in-the-browser-web-midi-api/
				// http://www.toptal.com/web/creating-browser-based-audio-applications-controlled-by-midi-hardware
				// https://webaudio.github.io/web-midi-api/
				// https://www.w3.org/TR/webmidi/
				function onMidiMessage(message) {
					var input = message.data[1];
					var value = message.data[2];
					if (input == 0) {
						var slider = document.getElementById('raw_sliders').children.item(0);
						slider.value = value/127;
						slider._onupdated();
					}
				}
				function bindMidiDevices(midiAccess) {
					for (var input of midiAccess.inputs.values()) {
						var midiDeviceConfig = midiDeviceConfigs[input.name];
						if (midiDeviceConfig) {
							input.onmidimessage = onMidiMessage;
							console.log(midiDeviceConfig);
						}
					}
				}
				if (window.navigator.requestMIDIAccess) {
					window.navigator.requestMIDIAccess({sysex: false}).then(
						bindMidiDevices,
						function() {console.warn('MIDI Access Failed');}
					);
				} else {
					console.warn("No browser MIDI support");
				}
			}
			
			// Slider ----------------------------------------------------------
			
			
			function createSlider(device, type, slider_group) {
				var slider = document.createElement('input');
				slider.setAttribute('type', 'range');
				slider.setAttribute('orient', 'vertical');
				slider.setAttribute('min', '0');
				slider.setAttribute('max', '1');
				slider.setAttribute('step', 1/255);
				slider.setAttribute('value', '0');
				slider.setAttribute('data-device', device);
				slider.setAttribute('data-type', type);
				slider._onupdated = function(){
					value = slider.value;  //event.target.value;
					if (Array.isArray(slider_group)) {
						var values = []; for (var index in slider_group) {values.push(slider_group[index].value);}
						value = type+':'+values.join(',');
					}
					send_lights(slider.getAttribute('data-device'), value);
				};
				slider.addEventListener('input', function(event){slider._onupdated()}, true);
				return slider;
			}
			
			function createSliderGroup(device, type, size) {
				var slider_group = [];
				for (var i=0 ; i<size ; i++) {
					slider_group.push(createSlider(device, type, slider_group));
				}
				return slider_group;
			}
			
			function appendChildren(parent, children) {
				for (var index in children) {
					parent.appendChild(children[index]);
				}
			}

			function raw_slider_controls() {
				var container = document.createElement('div');
				var index_display = document.createElement('input');
				index_display.value = 0;
				index_display.onchange = function() {
					sliders = document.getElementById('raw_sliders').getElementsByTagName('input');
					for (var index in sliders) {
						var slider = sliders[index];
						if (!slider.getAttribute) {continue;}
						slider.setAttribute('data-device', Number(index_display.value) + Number(index));
						slider.value = 0;
					}
				}
				
				function create_button(text, increment) {
					var button = document.createElement('button');
					button.innerHTML = text;
					button.onclick = function(event){
						index_display.value = Math.max(0, Number(index_display.value) + Number(increment));
						index_display.onchange();
					};
					return button;
				}
				
				appendChildren(container, [
					index_display,
					create_button('<', -NUM_RAW_SLIDERS),
					create_button('>',  NUM_RAW_SLIDERS),
				]);
				return container;
			}
			
			// Init ------------------------------------------------------------
			
			window.onload = function() {
				document.getElementById('host_input').value = localStorage.host || ((window.location.hostname || 'localhost')+":"+DEFAULT_PORT);
				
				// TODO: get these details from json config dynamically
				appendChildren(document.getElementById('hsv_top')  , createSliderGroup('top'  , 'hsv', 3));
				appendChildren(document.getElementById('hsv_floor'), createSliderGroup('floor', 'hsv', 3));
				
				var sliders = [];
				for (var i=0 ; i<NUM_RAW_SLIDERS ; i++) {
					sliders.push(createSlider(i));
				}
				appendChildren(document.getElementById('raw_sliders'), sliders);
				
				document.getElementById('raw_controls').appendChild(raw_slider_controls());
				
				connect();
				
				initMidi();
			}
		</script>
	</body>
</html>
